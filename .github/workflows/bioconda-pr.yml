name: bioconda-pr

on:
  push:
    branches:
      - main
    paths:
      - conda-recipe/meta.yaml
  workflow_dispatch:
    inputs:
      version:
        description: "Package version to publish (optional; defaults to conda-recipe/meta.yaml)"
        required: false
        type: string
      draft:
        description: "Create Bioconda PR as draft"
        required: true
        default: false
        type: boolean
      dry_run:
        description: "Run sync logic without pushing branch or creating PR"
        required: true
        default: false
        type: boolean

jobs:
  open-bioconda-pr:
    if: ${{ secrets.BIOCONDA_BOT_TOKEN != '' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      GH_TOKEN: ${{ secrets.BIOCONDA_BOT_TOKEN }}
      BIOCONDA_FORK_OWNER: ${{ vars.BIOCONDA_FORK_OWNER }}
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Prepare release metadata
        id: prep
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ github.event.inputs.version || '' }}" ]]; then
            version="${{ github.event.inputs.version }}"
          else
            version="$(python - <<'PY'
import re
from pathlib import Path

text = Path("conda-recipe/meta.yaml").read_text(encoding="utf-8")
match = re.search(r'\{%\s*set\s+version\s*=\s*"([^"]+)"\s*%\}', text)
if not match:
    raise SystemExit("Could not find version assignment in conda-recipe/meta.yaml")
print(match.group(1))
PY
)"
          fi

          if [[ -z "${version}" ]]; then
            echo "Version is empty" >&2
            exit 1
          fi

          fork_owner="${BIOCONDA_FORK_OWNER:-${GITHUB_REPOSITORY_OWNER}}"
          branch_version="$(echo "${version}" | sed 's/[^A-Za-z0-9._-]/-/g')"
          branch_name="permucn-v${branch_version}"

          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "fork_owner=${fork_owner}" >> "${GITHUB_OUTPUT}"
          echo "branch_name=${branch_name}" >> "${GITHUB_OUTPUT}"
          echo "fork_repo=${fork_owner}/bioconda-recipes" >> "${GITHUB_OUTPUT}"
          echo "head_ref=${fork_owner}:${branch_name}" >> "${GITHUB_OUTPUT}"

      - name: Resolve Bioconda default branch
        id: target
        shell: bash
        run: |
          set -euo pipefail
          base_branch="$(gh repo view bioconda/bioconda-recipes --json defaultBranchRef --jq '.defaultBranchRef.name')"
          if [[ -z "${base_branch}" ]]; then
            echo "Failed to resolve bioconda default branch" >&2
            exit 1
          fi
          echo "base_branch=${base_branch}" >> "${GITHUB_OUTPUT}"

      - name: Sync recipe into fork branch
        id: sync
        shell: bash
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          set -euo pipefail

          git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/${{ steps.prep.outputs.fork_repo }}.git" bioconda-recipes
          cd bioconda-recipes

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git show-ref --verify --quiet "refs/remotes/origin/${{ steps.target.outputs.base_branch }}"; then
            start_ref="origin/${{ steps.target.outputs.base_branch }}"
          else
            start_ref="$(git symbolic-ref --short refs/remotes/origin/HEAD)"
          fi
          git checkout -B "${{ steps.prep.outputs.branch_name }}" "${start_ref}"

          mkdir -p recipes/permucn
          cp ../conda-recipe/meta.yaml recipes/permucn/meta.yaml

          if git diff --quiet -- recipes/permucn/meta.yaml; then
            echo "No recipe changes detected."
            echo "changed=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          git add recipes/permucn/meta.yaml
          git commit -m "permucn: bump to ${{ steps.prep.outputs.version }}"

          if [[ "${DRY_RUN}" == "true" ]]; then
            echo "Dry run: skipping branch push."
          else
            git push --force-with-lease origin "${{ steps.prep.outputs.branch_name }}"
          fi

          echo "changed=true" >> "${GITHUB_OUTPUT}"

      - name: Create or update Bioconda PR
        if: steps.sync.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        id: pr
        shell: bash
        env:
          DRAFT: ${{ github.event.inputs.draft || 'false' }}
        run: |
          set -euo pipefail

          repo="bioconda/bioconda-recipes"
          title="permucn ${{ steps.prep.outputs.version }}"
          body=$(cat <<EOF
This PR updates \`permucn\` to version \`${{ steps.prep.outputs.version }}\`.

- Source recipe: https://github.com/${GITHUB_REPOSITORY}/blob/${GITHUB_SHA}/conda-recipe/meta.yaml
- PyPI: https://pypi.org/project/permucn/${{ steps.prep.outputs.version }}/
- GitHub Release: https://github.com/${GITHUB_REPOSITORY}/releases/tag/v${{ steps.prep.outputs.version }}
EOF
)

          existing_number="$(gh pr list \
            --repo "${repo}" \
            --state open \
            --head "${{ steps.prep.outputs.head_ref }}" \
            --json number \
            --jq '.[0].number // empty')"

          if [[ -n "${existing_number}" ]]; then
            gh pr edit "${existing_number}" --repo "${repo}" --title "${title}" --body "${body}"
            echo "pr_number=${existing_number}" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          create_cmd=(
            gh pr create
            --repo "${repo}"
            --base "${{ steps.target.outputs.base_branch }}"
            --head "${{ steps.prep.outputs.head_ref }}"
            --title "${title}"
            --body "${body}"
          )
          if [[ "${DRAFT}" == "true" ]]; then
            create_cmd+=(--draft)
          fi

          pr_url="$("${create_cmd[@]}")"
          echo "pr_url=${pr_url}" >> "${GITHUB_OUTPUT}"

      - name: Print result
        if: always()
        shell: bash
        run: |
          echo "version=${{ steps.prep.outputs.version }}"
          echo "fork=${{ steps.prep.outputs.fork_repo }}"
          echo "branch=${{ steps.prep.outputs.branch_name }}"
          echo "changed=${{ steps.sync.outputs.changed || 'false' }}"
          echo "pr_number=${{ steps.pr.outputs.pr_number || '' }}"
          echo "pr_url=${{ steps.pr.outputs.pr_url || '' }}"
